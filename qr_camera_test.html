<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Camera Scanner Test</title>
    <link rel="stylesheet" href="plugins/bootstrap/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      #qr_video {
        border-radius: 8px;
        background: #f8f9fa;
        border: 2px solid #007bff;
      }
      #camera_status {
        font-size: 0.9rem;
        min-height: 30px;
      }
      .scan-result {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        border: 1px solid #dee2e6;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0">
                <i class="fas fa-qrcode"></i> QR Code Camera Scanner Test
              </h4>
            </div>
            <div class="card-body">
              <div class="text-center">
                <video
                  id="qr_video"
                  width="400"
                  height="300"
                  style="max-width: 100%"
                ></video>
                <div class="mt-3">
                  <button
                    type="button"
                    id="start_camera"
                    class="btn btn-success"
                  >
                    <i class="fa fa-camera"></i> Start Camera
                  </button>
                  <button
                    type="button"
                    id="stop_camera"
                    class="btn btn-danger"
                    style="display: none"
                  >
                    <i class="fa fa-stop"></i> Stop Camera
                  </button>
                </div>
                <div id="camera_status" class="mt-3"></div>
              </div>

              <div class="scan-result" id="scan_result" style="display: none">
                <h6><i class="fa fa-qrcode"></i> Scanned QR Code:</h6>
                <div id="qr_data" class="alert alert-info"></div>
                <button class="btn btn-warning btn-sm" onclick="clearResult()">
                  <i class="fa fa-refresh"></i> Scan Again
                </button>
              </div>

              <div class="alert alert-info mt-3">
                <h6><i class="fa fa-info-circle"></i> Instructions:</h6>
                <ol>
                  <li>Click "Start Camera" to activate your device camera</li>
                  <li>Point the camera at a QR code</li>
                  <li>
                    The scanner will automatically detect and read the QR code
                  </li>
                  <li>The QR code content will be displayed below</li>
                </ol>
                <small
                  ><strong>Note:</strong> Your browser may ask for camera
                  permission. Please allow access to test the scanner.</small
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
      let videoStream = null;
      let qrCodeReader = null;

      function startCamera() {
        $("#camera_status").html(
          '<span class="text-info"><i class="fa fa-spinner fa-spin"></i> Starting camera...</span>'
        );

        navigator.mediaDevices
          .getUserMedia({
            video: {
              facingMode: "environment", // Use back camera if available
              width: { ideal: 400 },
              height: { ideal: 300 },
            },
          })
          .then(function (stream) {
            videoStream = stream;
            const video = document.getElementById("qr_video");
            video.srcObject = stream;
            video.play();

            $("#start_camera").hide();
            $("#stop_camera").show();
            $("#camera_status").html(
              '<span class="text-success"><i class="fa fa-check"></i> Camera active - Point at QR code</span>'
            );

            // Start scanning for QR codes
            scanQRCode();
          })
          .catch(function (err) {
            console.error("Error accessing camera:", err);
            $("#camera_status").html(
              '<span class="text-danger"><i class="fa fa-times"></i> Camera access denied or not available. Error: ' +
                err.message +
                "</span>"
            );
          });
      }

      function stopCamera() {
        if (videoStream) {
          videoStream.getTracks().forEach((track) => track.stop());
          videoStream = null;
        }

        const video = document.getElementById("qr_video");
        video.srcObject = null;

        $("#start_camera").show();
        $("#stop_camera").hide();
        $("#camera_status").html("");

        if (qrCodeReader) {
          clearTimeout(qrCodeReader);
          qrCodeReader = null;
        }
      }

      function scanQRCode() {
        const video = document.getElementById("qr_video");
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");

        function scan() {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = context.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );
            const code = jsQR(
              imageData.data,
              imageData.width,
              imageData.height
            );

            if (code) {
              // QR code detected
              $("#qr_data").text(code.data);
              $("#scan_result").show();
              $("#camera_status").html(
                '<span class="text-success"><i class="fa fa-check"></i> QR Code detected and scanned!</span>'
              );

              stopCamera();
              return; // Stop scanning
            }
          }

          // Continue scanning if camera is still active
          if (videoStream) {
            qrCodeReader = setTimeout(scan, 100); // Scan every 100ms for better responsiveness
          }
        }

        scan();
      }

      function clearResult() {
        $("#scan_result").hide();
        $("#qr_data").text("");
      }

      // Camera button events
      document
        .getElementById("start_camera")
        .addEventListener("click", startCamera);
      document
        .getElementById("stop_camera")
        .addEventListener("click", stopCamera);

      // Include jQuery for convenience
      if (typeof $ === "undefined") {
        function $(selector) {
          if (selector.startsWith("#")) {
            return {
              html: function (content) {
                const el = document.getElementById(selector.substring(1));
                if (el) el.innerHTML = content;
              },
              show: function () {
                const el = document.getElementById(selector.substring(1));
                if (el) el.style.display = "block";
              },
              hide: function () {
                const el = document.getElementById(selector.substring(1));
                if (el) el.style.display = "none";
              },
              text: function (content) {
                const el = document.getElementById(selector.substring(1));
                if (el) el.textContent = content;
              },
            };
          }
          return {};
        }
      }
    </script>
  </body>
</html>
